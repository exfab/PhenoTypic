
<!DOCTYPE html>


<html lang="en" data-content_root="../../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>phenotypic.tools.hdf_ &#8212; PhenoTypic</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=800a184d" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../_static/documentation_options.js?v=b3db6a4d"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="../../../_static/design-tabs.js?v=f930bc37"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/phenotypic/tools/hdf_';</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="0.11.1" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
     
  

<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../../_static/gradient_logo_exfab.svg" class="logo__image only-light" alt="PhenoTypic"/>
    <img src="../../../_static/gradient_logo_exfab.svg" class="logo__image only-dark pst-js-only" alt="PhenoTypic"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api_reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contrib_guide/index.html">
    Developer Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../downloadables.html">
    Downloads
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Wheeldon-Lab/PhenoScope#" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../user_guide/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../api_reference/index.html">
    API Reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../contrib_guide/index.html">
    Developer Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../downloadables.html">
    Downloads
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/Wheeldon-Lab/PhenoScope#" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">phenotypic.tools.hdf_</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for phenotypic.tools.hdf_</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">posixpath</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Literal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">packaging.version</span><span class="w"> </span><span class="kn">import</span> <span class="n">Version</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">phenotypic</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="HDF">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">HDF</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an interface to manage HDF5 files with support for single or set image modes,</span>
<span class="sd">    and ensures safe and compatible file access with retry and error-handling mechanisms.</span>

<span class="sd">    The class facilitates operations on HDF5 files commonly used for storing phenotypic</span>
<span class="sd">    data in both single image and image set modes. This class includes utilities to</span>
<span class="sd">    handle locking errors and ensure compatibility by initializing proper HDF5 modes</span>
<span class="sd">    while providing safe access methods for writing.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        filepath (Path): Path to the HDF5 file on the filesystem.</span>
<span class="sd">        name (str): Name associated with the HDF5 resource, often used as an identifier.</span>
<span class="sd">        mode (Literal[&#39;single&#39;, &#39;set&#39;]): Specifies the mode for the HDF5 file, either</span>
<span class="sd">            single image or image set.</span>
<span class="sd">        root_posix (str): The root path for the HDF5 resource, determined by the mode.</span>
<span class="sd">        home_posix (str): The specific root directory of the HDF5 resource in the file,</span>
<span class="sd">            derived based on its mode.</span>
<span class="sd">        set_data_posix (str, optional): The subgroup path for the data entity in image</span>
<span class="sd">            set mode, if applicable.</span>
<span class="sd">        SINGLE_IMAGE_ROOT_POSIX (str): Base path for single image mode.</span>
<span class="sd">        IMAGE_SET_ROOT_POSIX (str): Base path for image set mode.</span>
<span class="sd">        IMAGE_SET_DATA_POSIX (str): Subgroup marker for image set data.</span>
<span class="sd">        EXT (set): Set of valid file extensions used to recognize HDF5 files.</span>
<span class="sd">        IMAGE_MEASUREMENT_SUBGROUP_KEY (str): Key for accessing measurements in an</span>
<span class="sd">            image&#39;s group.</span>
<span class="sd">        IMAGE_STATUS_SUBGROUP_KEY (str): Key for accessing statuses in an image&#39;s group.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">Version</span><span class="p">(</span><span class="n">phenotypic</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">Version</span><span class="p">(</span><span class="s2">&quot;0.7.1&quot;</span><span class="p">):</span>
        <span class="n">SINGLE_IMAGE_ROOT_POSIX</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/phenotypic/&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">SINGLE_IMAGE_ROOT_POSIX</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/phenotypic/images/&#39;</span>

    <span class="n">IMAGE_SET_ROOT_POSIX</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/phenotypic/image_sets/&#39;</span>
    <span class="n">IMAGE_SET_DATA_POSIX</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>  <span class="c1"># The image and individual measurement group</span>

    <span class="c1"># measurements and status are stored within in each image&#39;s group</span>
    <span class="n">IMAGE_MEASUREMENT_SUBGROUP_KEY</span> <span class="o">=</span> <span class="s1">&#39;measurements&#39;</span>
    <span class="n">IMAGE_STATUS_SUBGROUP_KEY</span> <span class="o">=</span> <span class="s2">&quot;status&quot;</span>

    <span class="n">PROTECTED_METADATA_SUBGROUP_KEY</span> <span class="o">=</span> <span class="s2">&quot;protected_metadata&quot;</span>
    <span class="n">PUBLIC_METADATA_SUBGROUP_KEY</span> <span class="o">=</span> <span class="s2">&quot;public_metadata&quot;</span>

    <span class="n">EXT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;.hdf5&#39;</span><span class="p">,</span> <span class="s1">&#39;.hdf&#39;</span><span class="p">,</span> <span class="s1">&#39;.he5&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="HDF.__init__">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a class instance to manage HDF5 file structures for single or set image</span>
<span class="sd">        data based on the given filepath, name of the resource, and operational mode.</span>

<span class="sd">        Attributes:</span>
<span class="sd">            filepath (Path): Path to the HDF5 file.</span>
<span class="sd">            name (str): Identifier for the resource within the HDF5 file.</span>
<span class="sd">            mode (Literal[&#39;single&#39;, &#39;set&#39;]): Operational mode determining the structure</span>
<span class="sd">                and organization within the HDF5 file. Must be either &#39;single&#39; or &#39;set&#39;.</span>
<span class="sd">            root_posix (str): Posix path representing the root directory within the</span>
<span class="sd">                HDF5 file based on the mode.</span>
<span class="sd">            home_posix (str): Posix path representing the home directory for the resource</span>
<span class="sd">                within the HDF5 file based on the mode.</span>
<span class="sd">            set_data_posix (Optional[str]): Posix path for the data subdirectory within</span>
<span class="sd">                the resource home directory. Only initialized in &#39;set&#39; mode.</span>

<span class="sd">        Args:</span>
<span class="sd">            filepath: Path to the target HDF5 file. Must have an HDF5-compatible extension,</span>
<span class="sd">                or a ValueError is raised.</span>
<span class="sd">            name: Name of the resource to be managed in the file. Used to construct the</span>
<span class="sd">                home directory for the resource within the HDF5 file.</span>
<span class="sd">            mode: Operational mode. Specifies whether the resource represents a &#39;single&#39;</span>
<span class="sd">                or &#39;set&#39; image data. If the mode is invalid, a ValueError is raised.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the filepath does not have an HDF5-compatible extension.</span>
<span class="sd">            ValueError: If the mode is neither &#39;single&#39; nor &#39;set&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXT</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;filepath is not an hdf5 file&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">hdf</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_posix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SINGLE_IMAGE_ROOT_POSIX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">home_posix</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SINGLE_IMAGE_ROOT_POSIX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_posix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMAGE_SET_ROOT_POSIX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">home_posix</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IMAGE_SET_ROOT_POSIX</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_data_posix</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">home_posix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMAGE_SET_DATA_POSIX</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.safe_writer">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.safe_writer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">safe_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a writer object that provides safe and controlled write access to an</span>
<span class="sd">        HDF5 file at the specified filepath or creates it if it doesn&#39;t exist. Ensures that the file uses the &#39;latest&#39;</span>
<span class="sd">        version of the HDF5 library for compatibility and performance.</span>
<span class="sd">        </span>
<span class="sd">        Handles HDF5 file locking conflicts by attempting to clear consistency flags</span>
<span class="sd">        and retrying file opening with exponential backoff.</span>

<span class="sd">        Returns:</span>
<span class="sd">            h5py.File: A file writer object with append mode and &#39;latest&#39; library</span>
<span class="sd">            version enabled.</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            OSError: If file cannot be opened after all retry attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">retry_delay</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># Handle various HDF5 locking scenarios</span>
                <span class="n">is_lock_error</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span>
                    <span class="s2">&quot;file is already open for write/swmr write&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;file is already open&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;unable to lock file&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;resource temporarily unavailable&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;file locking disabled&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span>
                <span class="p">])</span>

                <span class="k">if</span> <span class="n">is_lock_error</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HDF5 file access conflict (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Try to clear HDF5 consistency flags if h5clear is available</span>
                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Don&#39;t try h5clear on last attempt</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to clear HDF5 consistency flags for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">result</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;h5clear&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)],</span>
                                                        <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Successfully cleared HDF5 consistency flags&quot;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;h5clear failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">stderr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span>
                                <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">clear_error</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not run h5clear: </span><span class="si">{</span><span class="n">clear_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="c1"># Wait before retrying</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">retry_delay</span><span class="si">}</span><span class="s2"> seconds before retry...&quot;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
                        <span class="n">retry_delay</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># Exponential backoff</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Last attempt failed - provide helpful error message</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open HDF5 file after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open HDF5 file after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                                           <span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> may be locked by another process. &quot;</span>
                                           <span class="sa">f</span><span class="s2">&quot;Try manually running: h5clear -s </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> &amp;&amp; h5clear -f </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Different OSError, re-raise immediately</span>
                    <span class="k">raise</span>

        <span class="c1"># This should not be reached due to the raise in the loop</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error opening HDF5 file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.swmr_writer">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.swmr_writer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">swmr_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a writer object that provides safe SWMR-compatible write access to an</span>
<span class="sd">        HDF5 file. Creates the file if it doesn&#39;t exist and enables SWMR mode properly.</span>
<span class="sd">        </span>
<span class="sd">        This method ensures proper SWMR mode initialization by creating the file</span>
<span class="sd">        with the correct settings from the start, avoiding cache conflicts that</span>
<span class="sd">        occur when trying to enable SWMR mode after opening.</span>
<span class="sd">        </span>
<span class="sd">        Returns:</span>
<span class="sd">            h5py.File: A file writer object with SWMR mode enabled.</span>
<span class="sd">            </span>
<span class="sd">        Raises:</span>
<span class="sd">            OSError: If file cannot be opened after all retry attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">max_retries</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">retry_delay</span> <span class="o">=</span> <span class="mf">0.5</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Create/open file with proper SWMR settings</span>
                <span class="n">file_handle</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span>
                <span class="c1"># Enable SWMR mode immediately after opening</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">file_handle</span><span class="o">.</span><span class="n">swmr_mode</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SWMR mode enabled successfully for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">file_handle</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">swmr_error</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not enable SWMR mode: </span><span class="si">{</span><span class="n">swmr_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="c1"># Return file handle without SWMR mode as fallback</span>
                    <span class="k">return</span> <span class="n">file_handle</span>

            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="c1"># Handle various HDF5 locking scenarios</span>
                <span class="n">is_lock_error</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span>
                    <span class="s2">&quot;file is already open for write/swmr write&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;file is already open&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;unable to lock file&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;resource temporarily unavailable&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;file locking disabled&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;ring type mismatch&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span><span class="p">,</span>
                    <span class="s2">&quot;pinned entry count&quot;</span> <span class="ow">in</span> <span class="n">error_msg</span>
                <span class="p">])</span>

                <span class="k">if</span> <span class="n">is_lock_error</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HDF5 SWMR file access conflict (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="c1"># Try to clear HDF5 consistency flags if h5clear is available</span>
                    <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Don&#39;t try h5clear on last attempt</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Attempting to clear HDF5 consistency flags for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="c1"># Clear both status and force flags for SWMR issues</span>
                                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;h5clear&#39;</span><span class="p">,</span> <span class="s1">&#39;-s&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)],</span>
                                               <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;h5clear&#39;</span><span class="p">,</span> <span class="s1">&#39;-f&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">)],</span>
                                               <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleared HDF5 consistency flags&quot;</span><span class="p">)</span>
                        <span class="k">except</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">,</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">,</span>
                                <span class="ne">FileNotFoundError</span><span class="p">)</span> <span class="k">as</span> <span class="n">clear_error</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not run h5clear: </span><span class="si">{</span><span class="n">clear_error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="c1"># Wait before retrying</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">retry_delay</span><span class="si">}</span><span class="s2"> seconds before retry...&quot;</span><span class="p">)</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">retry_delay</span><span class="p">)</span>
                        <span class="n">retry_delay</span> <span class="o">*=</span> <span class="mi">2</span>  <span class="c1"># Exponential backoff</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># Last attempt failed - provide helpful error message</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open HDF5 file in SWMR mode after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to open HDF5 file in SWMR mode after </span><span class="si">{</span><span class="n">max_retries</span><span class="si">}</span><span class="s2"> attempts. &quot;</span>
                                           <span class="sa">f</span><span class="s2">&quot;The file </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> may have cache conflicts. &quot;</span>
                                           <span class="sa">f</span><span class="s2">&quot;Try manually running: h5clear -s </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> &amp;&amp; h5clear -f </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Different OSError, re-raise immediately</span>
                    <span class="k">raise</span>

        <span class="c1"># This should not be reached due to the raise in the loop</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error opening HDF5 file in SWMR mode </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.strict_writer">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.strict_writer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">strict_writer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides access to an HDF5 file in read/write mode using the `h5py` library. This</span>
<span class="sd">        property is used to obtain an `h5py.File` object configured with the latest library version.</span>

<span class="sd">        Note:</span>
<span class="sd">            If using SWMR mode, don&#39;t forget to enable SWMR mode with:</span>
<span class="sd">                .. code-block:: python</span>
<span class="sd">                    hdf = HDF(filepath)</span>
<span class="sd">                    with hdf.writer as writer:</span>
<span class="sd">                        writer.swmr_mode = True</span>
<span class="sd">                        # rest of your code</span>

<span class="sd">        Returns:</span>
<span class="sd">            h5py.File: An HDF5 file object opened in &#39;r+&#39; mode, enabling reading and writing.</span>

<span class="sd">        Raises:</span>
<span class="sd">            OSError: If the file cannot be opened or accessed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.swmr_reader">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.swmr_reader">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">swmr_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span> <span class="n">swmr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.reader">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.reader">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">libver</span><span class="o">=</span><span class="s1">&#39;latest&#39;</span><span class="p">,</span> <span class="n">swmr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.get_group">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_group">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_group</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">posix</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves or creates a group in an HDF5 file.</span>

<span class="sd">        This method checks the validity of the provided HDF5 file handle and tries to</span>
<span class="sd">        retrieve the specified group based on the given posix path. If the group does not</span>
<span class="sd">        exist and the file is not opened in read-only mode, the group gets created. If the</span>
<span class="sd">        file is in read-only mode and the group does not exist, an error is raised.</span>

<span class="sd">        Args:</span>
<span class="sd">            handle (h5py.File): The HDF5 file handle to operate on.</span>
<span class="sd">            posix (str): The posix path of the group to retrieve or create in the HDF5 file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            h5py.Group: The corresponding h5py group within the HDF5 file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the HDF5 file handle is invalid or no longer valid.</span>
<span class="sd">            ValueError: If the file handle mode cannot be determined.</span>
<span class="sd">            KeyError: If the specified group does not exist in read-only mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">posix</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">posix</span><span class="p">)</span>

        <span class="c1"># Check if the handle is valid before accessing it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Test if handle is still valid by checking if it&#39;s open</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">handle</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;HDF5 file handle is no longer valid (file may have been closed)&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid HDF5 file handle: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">posix</span> <span class="ow">in</span> <span class="n">handle</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">handle</span><span class="p">[</span><span class="n">posix</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check if file is opened in read-only mode - with error handling</span>
            <span class="c1"># Handle both File and Group objects (Groups have a .file attribute)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
                    <span class="c1"># For Group objects, access the parent file</span>
                    <span class="n">file_obj</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">file</span>
                    <span class="n">file_mode</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">mode</span>
                    <span class="n">swmr_mode</span> <span class="o">=</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">swmr_mode</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># For File objects, access directly</span>
                    <span class="n">file_mode</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">mode</span>
                    <span class="n">swmr_mode</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">swmr_mode</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot determine file mode - HDF5 handle may be invalid: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">file_mode</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group &#39;</span><span class="si">{</span><span class="n">posix</span><span class="si">}</span><span class="s2">&#39; not found in HDF5 file opened in read-only mode&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">swmr_mode</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group &#39;</span><span class="si">{</span><span class="n">posix</span><span class="si">}</span><span class="s2">&#39; not found in HDF5 file opened in SWMR mode&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># File has write permissions, safe to create group</span>
                <span class="k">return</span> <span class="n">handle</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">posix</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.get_home">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_home">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_home</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves a specific group from an HDF file corresponding to single image data.</span>

<span class="sd">        This method is used to fetch a predefined group from an HDF container, where the group</span>
<span class="sd">        is identified by a constant key related to single image data. The function provides</span>
<span class="sd">        a static interface allowing invocation without requiring an instance of the class.</span>

<span class="sd">        Args:</span>
<span class="sd">            handle: The HDF file handle from which the group should be retrieved.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The group corresponding to single image data, retrieved based on the defined</span>
<span class="sd">            SINGLE_IMAGE_ROOT_POSIX.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Appropriate exceptions may be raised by the underlying HDF.get_group() method,</span>
<span class="sd">            based on the implementation and provided handle or key.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="n">handle</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">home_posix</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.get_root_group">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_root_group">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_root_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="n">handle</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">root_posix</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.get_data_group">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_data_group">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_data_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">&#39;This method is only available for image sets&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_data_posix</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.get_image_group">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_image_group">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">image_name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_home</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_data_posix</span><span class="p">,</span> <span class="n">image_name</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid mode </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.get_image_measurement_subgroup">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_image_measurement_subgroup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_measurement_subgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">image_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
                              <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_data_posix</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMAGE_MEASUREMENT_SUBGROUP_KEY</span><span class="p">))</span></div>


<div class="viewcode-block" id="HDF.get_status_subgroup">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_status_subgroup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_status_subgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">image_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_data_posix</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">IMAGE_STATUS_SUBGROUP_KEY</span><span class="p">))</span></div>


<div class="viewcode-block" id="HDF.get_protected_metadata_subgroup">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_protected_metadata_subgroup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_protected_metadata_subgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">image_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="n">handle</span><span class="p">,</span> <span class="n">posix</span><span class="o">=</span><span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_data_posix</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">PROTECTED_METADATA_SUBGROUP_KEY</span><span class="p">))</span></div>


<div class="viewcode-block" id="HDF.get_public_metadata_subgroup">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_public_metadata_subgroup">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_public_metadata_subgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">image_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">handle</span><span class="o">=</span><span class="n">handle</span><span class="p">,</span>
                              <span class="n">posix</span><span class="o">=</span><span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_data_posix</span><span class="p">,</span> <span class="n">image_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">PUBLIC_METADATA_SUBGROUP_KEY</span><span class="p">))</span></div>


<div class="viewcode-block" id="HDF.save_array2hdf5">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.save_array2hdf5">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_array2hdf5</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves a given numpy array to an HDF5 group. If a dataset with the specified</span>
<span class="sd">        name already exists in the group, it checks if the shapes match. If the</span>
<span class="sd">        shapes match, it updates the existing dataset; otherwise, it removes the</span>
<span class="sd">        existing dataset and creates a new one with the specified name. If a dataset</span>
<span class="sd">        with the given name doesn&#39;t exist, it creates a new dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: h5py.Group</span>
<span class="sd">                The HDF5 group in which the dataset will be saved.</span>
<span class="sd">            array: numpy.ndarray</span>
<span class="sd">                The data array to be stored in the dataset.</span>
<span class="sd">            name: str</span>
<span class="sd">                The name of the dataset within the group.</span>
<span class="sd">            **kwargs: dict</span>
<span class="sd">                Additional keyword arguments to pass when creating a new dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">dset</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dset</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="n">dset</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">group</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">array</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">array</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


    <span class="c1"># =================== PANDAS2HDF FUNCTIONALITY ===================</span>

<div class="viewcode-block" id="HDF.assert_swmr_on">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.assert_swmr_on">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">assert_swmr_on</span><span class="p">(</span><span class="n">g</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assert that SWMR mode is enabled on the group&#39;s file.</span>

<span class="sd">        Args:</span>
<span class="sd">            g: HDF5 group to check.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If SWMR mode is not enabled.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">swmr_mode</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;SWMR mode is required but not enabled on file </span><span class="si">{</span><span class="n">g</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="HDF.get_uncompressed_sizes_for_group">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.get_uncompressed_sizes_for_group">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_uncompressed_sizes_for_group</span><span class="p">(</span><span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively collect the uncompressed (logical) sizes of SWMR-compatible datasets.</span>

<span class="sd">        This function walks the provided HDF5 group and inspects every dataset without</span>
<span class="sd">        reading any data. For each dataset that is compatible with SWMR writing rules</span>
<span class="sd">        (i.e., chunked layout and no variable-length data types), it computes the</span>
<span class="sd">        uncompressed size in bytes as: dtype.itemsize * number_of_elements.</span>

<span class="sd">        Notes</span>
<span class="sd">        - This works regardless of whether datasets are stored compressed on disk; the</span>
<span class="sd">          reported size is the logical size when uncompressed in memory.</span>
<span class="sd">        - Variable-length strings (and datasets containing variable-length fields) are</span>
<span class="sd">          excluded because they are not SWMR-write friendly and their uncompressed size</span>
<span class="sd">          cannot be determined from metadata alone.</span>
<span class="sd">        - The operation is safe under SWMR: it only reads object metadata, creates no</span>
<span class="sd">          new refine, and does not modify the file.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: The root h5py.Group to traverse.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple (sizes, total_bytes) where:</span>
<span class="sd">            - sizes: dict mapping absolute dataset paths (e.g., &#39;/grp/ds&#39;) to uncompressed</span>
<span class="sd">              size in bytes.</span>
<span class="sd">            - total_bytes: sum of all values in sizes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_np</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_h5py</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_dtype_has_vlen</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return True if dtype is or contains variable-length elements.&quot;&quot;&quot;</span>
            <span class="c1"># Direct vlen</span>
            <span class="k">if</span> <span class="n">_h5py</span><span class="o">.</span><span class="n">check_vlen_dtype</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="c1"># String vlen</span>
            <span class="k">if</span> <span class="n">_h5py</span><span class="o">.</span><span class="n">check_string_dtype</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">info</span> <span class="o">=</span> <span class="n">_h5py</span><span class="o">.</span><span class="n">check_string_dtype</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
                <span class="c1"># info.length is None for variable-length strings</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
                <span class="k">return</span> <span class="kc">False</span>  <span class="c1"># fixed-length string</span>
            <span class="c1"># Compound: check fields recursively</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="p">(</span><span class="n">subdt</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dt</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">_dtype_has_vlen</span><span class="p">(</span><span class="n">subdt</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">sizes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_visitor</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">_h5py</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="n">_h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_h5py</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
                <span class="c1"># SWMR-write compatibility: chunked layout required</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="c1"># Exclude variable-length dtypes (including vlen strings)</span>
                <span class="k">if</span> <span class="n">_dtype_has_vlen</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
                    <span class="k">return</span>
                <span class="c1"># Compute logical size without reading data</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">n_elems</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># Fallback for unusual shapes</span>
                    <span class="n">n_elems</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">itemsize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
                <span class="n">sizes</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">itemsize</span><span class="o">*</span><span class="n">n_elems</span>

        <span class="n">group</span><span class="o">.</span><span class="n">visititems</span><span class="p">(</span><span class="n">_visitor</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">sizes</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">sizes</span><span class="p">,</span> <span class="n">total</span></div>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_string_dtype</span><span class="p">(</span><span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">special_dtype</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get UTF-8 string dtype for HDF5.</span>

<span class="sd">        Args:</span>
<span class="sd">            length: If None, returns variable-length string dtype.</span>
<span class="sd">                    If an integer, returns fixed-length string dtype with that character length.</span>

<span class="sd">        Returns:</span>
<span class="sd">            HDF5 string dtype (variable-length or fixed-length).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">h5py</span><span class="o">.</span><span class="n">string_dtype</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert to native Python int to avoid h5py type issues</span>
            <span class="k">return</span> <span class="n">h5py</span><span class="o">.</span><span class="n">string_dtype</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_pad_or_truncate_string</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">fixed_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pad or truncate a string to a fixed character length.</span>

<span class="sd">        Args:</span>
<span class="sd">            s: Input string.</span>
<span class="sd">            fixed_length: Target character length.</span>

<span class="sd">        Returns:</span>
<span class="sd">            String padded with spaces or truncated to exactly fixed_length characters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fixed_length</span><span class="p">:</span>
            <span class="c1"># Pad with spaces on the right</span>
            <span class="k">return</span> <span class="n">s</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span><span class="o">*</span><span class="p">(</span><span class="n">fixed_length</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fixed_length</span><span class="p">:</span>
            <span class="c1"># Truncate to exactly fixed_length characters</span>
            <span class="k">return</span> <span class="n">s</span><span class="p">[:</span><span class="n">fixed_length</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Already the right length</span>
            <span class="k">return</span> <span class="n">s</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_fixed_length_to_strings</span><span class="p">(</span>
            <span class="n">str_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
            <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
            <span class="n">fixed_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply fixed-length padding/truncation to string array.</span>

<span class="sd">        Args:</span>
<span class="sd">            str_array: Array of strings.</span>
<span class="sd">            mask: Mask array (1=valid, 0=missing).</span>
<span class="sd">            fixed_length: Target character length.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Array with strings padded/truncated to fixed_length.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># Ensure we&#39;re working with proper Unicode strings</span>
            <span class="n">original_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">processed_str</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_pad_or_truncate_string</span><span class="p">(</span><span class="n">original_str</span><span class="p">,</span> <span class="n">fixed_length</span><span class="p">)</span>
            <span class="c1"># Encode to UTF-8 bytes to ensure it fits in fixed-length storage</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">processed_str</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_trim_trailing_whitespace</span><span class="p">(</span><span class="n">s</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trim trailing whitespace from a string.</span>

<span class="sd">        Args:</span>
<span class="sd">            s: Input string.</span>

<span class="sd">        Returns:</span>
<span class="sd">            String with trailing whitespace removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_decode_fixed_length_strings</span><span class="p">(</span>
            <span class="n">str_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decode fixed-length strings and trim trailing whitespace from valid entries.</span>

<span class="sd">        Args:</span>
<span class="sd">            str_array: Array of fixed-length strings.</span>
<span class="sd">            mask: Mask array (1=valid, 0=missing).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Object array with trimmed strings and None for missing values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">str_array</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="c1"># Set valid entries with trimmed strings</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_indices</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">raw_str</span> <span class="o">=</span> <span class="n">str_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">raw_str</span> <span class="o">=</span> <span class="n">raw_str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_trim_trailing_whitespace</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">raw_str</span><span class="p">))</span>

        <span class="c1"># Set missing entries to None</span>
        <span class="n">result</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_values_for_hdf5</span><span class="p">(</span>
            <span class="n">values</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">string_fixed_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode pandas Series values for HDF5 storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            values: pandas Series to encode.</span>
<span class="sd">            string_fixed_length: If provided, use fixed-length strings with this character length.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (encoded_values, mask, values_kind, orig_dtype):</span>
<span class="sd">            - encoded_values: numpy array ready for HDF5 storage</span>
<span class="sd">            - mask: optional mask array (uint8, 1=valid, 0=missing) for strings</span>
<span class="sd">            - values_kind: &quot;numeric_float64&quot;, &quot;string_utf8_fixed&quot;, or &quot;string_utf8_vlen&quot;</span>
<span class="sd">            - orig_dtype: string representation of original dtype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orig_dtype</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_bool_dtype</span><span class="p">(</span>
                <span class="n">values</span><span class="o">.</span><span class="n">dtype</span>
        <span class="p">):</span>
            <span class="c1"># Convert to float64, with NaN for missing values</span>
            <span class="n">encoded</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">values_kind</span> <span class="o">=</span> <span class="s2">&quot;numeric_float64&quot;</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_object_dtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="c1"># Check if object dtype contains boolean-like values</span>
            <span class="n">non_null_values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_null_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bool</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span> <span class="ow">or</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">non_null_values</span>
            <span class="p">):</span>
                <span class="c1"># Treat as boolean/numeric data</span>
                <span class="n">encoded</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">values_kind</span> <span class="o">=</span> <span class="s2">&quot;numeric_float64&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Treat as string data</span>
                <span class="n">str_values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">values</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="c1"># Replace NaN string representations with empty strings</span>
                <span class="n">str_array</span> <span class="o">=</span> <span class="n">str_values</span><span class="o">.</span><span class="n">values</span>
                <span class="n">str_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="k">if</span> <span class="n">string_fixed_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Apply fixed-length padding/truncation</span>
                    <span class="n">str_array</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_apply_fixed_length_to_strings</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">str_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">string_fixed_length</span>
                    <span class="p">)</span>
                    <span class="c1"># Create array with explicit UTF-8 encoding for fixed-length</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">encoded</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">(</span><span class="n">string_fixed_length</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                        <span class="c1"># Fallback: truncate to ASCII-safe characters if Unicode fails</span>
                        <span class="n">ascii_safe_array</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">str_array</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="c1"># Keep only ASCII characters for problematic Unicode</span>
                                <span class="n">ascii_safe_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                                        <span class="s2">&quot;ascii&quot;</span>
                                <span class="p">)[:</span><span class="n">string_fixed_length</span><span class="p">]</span>
                        <span class="n">encoded</span> <span class="o">=</span> <span class="n">ascii_safe_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                                <span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">(</span><span class="n">string_fixed_length</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="n">values_kind</span> <span class="o">=</span> <span class="s2">&quot;string_utf8_fixed&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">encoded</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">())</span>
                    <span class="n">values_kind</span> <span class="o">=</span> <span class="s2">&quot;string_utf8_vlen&quot;</span>
        <span class="k">elif</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_string_dtype</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="p">):</span>
            <span class="c1"># Convert to UTF-8 strings with mask for missing values</span>
            <span class="n">str_values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">values</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="c1"># Replace NaN string representations with empty strings</span>
            <span class="n">str_array</span> <span class="o">=</span> <span class="n">str_values</span><span class="o">.</span><span class="n">values</span>
            <span class="n">str_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="n">string_fixed_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Apply fixed-length padding/truncation</span>
                <span class="n">str_array</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_apply_fixed_length_to_strings</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">str_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">string_fixed_length</span>
                <span class="p">)</span>
                <span class="c1"># Create array with explicit UTF-8 encoding for fixed-length</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">encoded</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">(</span><span class="n">string_fixed_length</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                    <span class="c1"># Fallback: truncate to ASCII-safe characters if Unicode fails</span>
                    <span class="n">ascii_safe_array</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">str_array</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="c1"># Keep only ASCII characters for problematic Unicode</span>
                            <span class="n">ascii_safe_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
                                    <span class="s2">&quot;ascii&quot;</span>
                            <span class="p">)[:</span><span class="n">string_fixed_length</span><span class="p">]</span>
                    <span class="n">encoded</span> <span class="o">=</span> <span class="n">ascii_safe_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                            <span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">(</span><span class="n">string_fixed_length</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">values_kind</span> <span class="o">=</span> <span class="s2">&quot;string_utf8_fixed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">encoded</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">())</span>
                <span class="n">values_kind</span> <span class="o">=</span> <span class="s2">&quot;string_utf8_vlen&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported dtype: </span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure we return numpy arrays, not ExtensionArrays</span>
        <span class="n">encoded_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
        <span class="n">mask_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">encoded_array</span><span class="p">,</span> <span class="n">mask_array</span><span class="p">,</span> <span class="n">values_kind</span><span class="p">,</span> <span class="n">orig_dtype</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_encode_index_for_hdf5</span><span class="p">(</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">string_fixed_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]]],</span>
        <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="nb">str</span><span class="p">,</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Encode pandas Index/MultiIndex for HDF5 storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            index: pandas Index or MultiIndex to encode.</span>
<span class="sd">            string_fixed_length: If provided, use fixed-length strings with this character length.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (encoded_arrays, mask_arrays, metadata, orig_dtype):</span>
<span class="sd">            - encoded_arrays: array or list of arrays for MultiIndex levels</span>
<span class="sd">            - mask_arrays: mask array or list of mask arrays</span>
<span class="sd">            - metadata: dict with index metadata</span>
<span class="sd">            - orig_dtype: string representation of original dtype</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">orig_dtype</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;MultiIndex&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">):</span>
            <span class="c1"># Handle MultiIndex</span>
            <span class="n">encoded_arrays</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mask_arrays</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">level_values</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">:</span>
                <span class="n">level_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">level_values</span><span class="p">)</span>
                <span class="n">str_values</span> <span class="o">=</span> <span class="n">level_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">level_series</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="c1"># Replace NaN representations</span>
                <span class="n">str_array</span> <span class="o">=</span> <span class="n">str_values</span><span class="o">.</span><span class="n">values</span>
                <span class="n">str_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">level_series</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="k">if</span> <span class="n">string_fixed_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Apply fixed-length padding/truncation</span>
                    <span class="n">str_array</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_apply_fixed_length_to_strings</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">str_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">string_fixed_length</span>
                    <span class="p">)</span>
                    <span class="n">encoded_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">str_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">(</span><span class="n">string_fixed_length</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">encoded_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">str_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">()))</span>
                <span class="n">mask_arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>

            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;index_is_multiindex&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;index_levels&quot;</span>       <span class="p">:</span> <span class="n">index</span><span class="o">.</span><span class="n">nlevels</span><span class="p">,</span>
                <span class="s2">&quot;index_names&quot;</span>        <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">string_fixed_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;index_kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string_utf8_fixed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;index_kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string_utf8_vlen&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Handle regular Index</span>
            <span class="n">index_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">str_values</span> <span class="o">=</span> <span class="n">index_series</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">index_series</span><span class="o">.</span><span class="n">isna</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="c1"># Replace NaN representations</span>
            <span class="n">str_array</span> <span class="o">=</span> <span class="n">str_values</span><span class="o">.</span><span class="n">values</span>
            <span class="n">str_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">index_series</span><span class="o">.</span><span class="n">isna</span><span class="p">())]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="n">string_fixed_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Apply fixed-length padding/truncation</span>
                <span class="n">str_array</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_apply_fixed_length_to_strings</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">str_array</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mask</span><span class="p">),</span> <span class="n">string_fixed_length</span>
                <span class="p">)</span>
                <span class="n">encoded_arrays</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                        <span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">(</span><span class="n">string_fixed_length</span><span class="p">))</span>  <span class="c1"># type: ignore[assignment]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">encoded_arrays</span> <span class="o">=</span> <span class="n">str_array</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">())</span>  <span class="c1"># type: ignore[assignment]</span>
            <span class="n">mask_arrays</span> <span class="o">=</span> <span class="n">mask</span>  <span class="c1"># type: ignore[assignment]</span>

            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;index_is_multiindex&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;index_levels&quot;</span>       <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;index_names&quot;</span>        <span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span>
                <span class="p">),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">string_fixed_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;index_kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string_utf8_fixed&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;index_kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string_utf8_vlen&quot;</span>

        <span class="k">return</span> <span class="n">encoded_arrays</span><span class="p">,</span> <span class="n">mask_arrays</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">orig_dtype</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_decode_values_from_hdf5</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">dataset_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decode values from HDF5 storage back to numpy array.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group containing the datasets.</span>
<span class="sd">            dataset_name: Name of the values dataset.</span>
<span class="sd">            length: Logical length to read (respects preallocated space).</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (decoded_values, values_kind).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values_kind</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;values_kind&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values_kind</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">values_kind</span> <span class="o">=</span> <span class="n">values_kind</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">logical_length</span> <span class="o">=</span> <span class="n">length</span> <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">values_kind</span> <span class="o">==</span> <span class="s2">&quot;numeric_float64&quot;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">][:</span><span class="n">logical_length</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">values_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_vlen&quot;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">][:</span><span class="n">logical_length</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">][:</span><span class="n">logical_length</span><span class="p">]</span>
            <span class="c1"># Convert back to object array with proper NaN handling</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">logical_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="n">result</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">elif</span> <span class="n">values_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">dataset_name</span><span class="p">][:</span><span class="n">logical_length</span><span class="p">]</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset_name</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">][:</span><span class="n">logical_length</span><span class="p">]</span>
            <span class="c1"># Decode fixed-length strings and trim trailing whitespace</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_decode_fixed_length_strings</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown values_kind: </span><span class="si">{</span><span class="n">values_kind</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span><span class="p">,</span> <span class="n">values_kind</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_decode_index_from_hdf5</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">index_dataset_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="n">length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Decode index from HDF5 storage back to pandas Index/MultiIndex.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group containing the index datasets.</span>
<span class="sd">            index_dataset_name: Base name for index datasets.</span>
<span class="sd">            length: Logical length to read.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Reconstructed pandas Index or MultiIndex.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logical_length</span> <span class="o">=</span> <span class="n">length</span> <span class="k">if</span> <span class="n">length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
        <span class="n">is_multiindex</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;index_is_multiindex&quot;</span><span class="p">])</span>
        <span class="n">index_names_attr</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;index_names&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_names_attr</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">index_names_attr</span> <span class="o">=</span> <span class="n">index_names_attr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">index_names</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">index_names_attr</span><span class="p">)</span>

        <span class="c1"># Check if index uses fixed-length strings</span>
        <span class="n">index_kind</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_kind&quot;</span><span class="p">,</span> <span class="s2">&quot;string_utf8_vlen&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index_kind</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">index_kind</span> <span class="o">=</span> <span class="n">index_kind</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_multiindex</span><span class="p">:</span>
            <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;index_levels&quot;</span><span class="p">]):</span>
                <span class="n">level_data</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_dataset_name</span><span class="si">}</span><span class="s2">/levels/L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">][:</span><span class="n">logical_length</span><span class="p">]</span>
                <span class="n">level_mask</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_dataset_name</span><span class="si">}</span><span class="s2">/levels/L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">][</span>
                    <span class="p">:</span><span class="n">logical_length</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="n">index_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
                    <span class="c1"># Decode fixed-length strings and trim trailing whitespace</span>
                    <span class="n">level_values</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_decode_fixed_length_strings</span><span class="p">(</span><span class="n">level_data</span><span class="p">,</span> <span class="n">level_mask</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Original variable-length string handling</span>
                    <span class="n">level_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">logical_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
                    <span class="n">level_values</span><span class="p">[</span><span class="n">level_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">level_data</span><span class="p">[</span><span class="n">level_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">]</span>
                    <span class="n">level_values</span><span class="p">[</span><span class="n">level_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">level_values</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">index_names</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_data</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_dataset_name</span><span class="si">}</span><span class="s2">/values&quot;</span><span class="p">][:</span><span class="n">logical_length</span><span class="p">]</span>
            <span class="n">index_mask</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_dataset_name</span><span class="si">}</span><span class="s2">/index_mask&quot;</span><span class="p">][:</span><span class="n">logical_length</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">index_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
                <span class="c1"># Decode fixed-length strings and trim trailing whitespace</span>
                <span class="n">index_values</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_decode_fixed_length_strings</span><span class="p">(</span><span class="n">index_data</span><span class="p">,</span> <span class="n">index_mask</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Original variable-length string handling</span>
                <span class="n">index_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">logical_length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
                <span class="n">index_values</span><span class="p">[</span><span class="n">index_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">index_data</span><span class="p">[</span><span class="n">index_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">index_values</span><span class="p">[</span><span class="n">index_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">index_values</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">index_names</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_create_resizable_dataset</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">dtype</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
            <span class="n">shape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">maxshape</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">chunks</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
            <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a resizable, chunked, compressed dataset.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">maxshape</span><span class="o">=</span><span class="n">maxshape</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
                <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># =================== MAIN PANDAS2HDF FUNCTIONS ===================</span>

<div class="viewcode-block" id="HDF.preallocate_series_layout">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.preallocate_series_layout">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">preallocate_series_layout</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span>
            <span class="n">index_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="n">chunks</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,),</span>
            <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="n">preallocate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">string_fixed_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preallocate HDF5 layout for a pandas Series without writing data.</span>

<span class="sd">        Creates resizable, chunked, compressed datasets with initial shape (preallocate,)</span>
<span class="sd">        and maxshape (None,). Initializes masks to zeros and sets len=0.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group to write to.</span>
<span class="sd">            series: pandas Series to create layout for (used for schema).</span>
<span class="sd">            dataset: Name for the values dataset.</span>
<span class="sd">            index_dataset: Name for the index dataset.</span>
<span class="sd">            chunks: Chunk shape for datasets.</span>
<span class="sd">            compression: Compression algorithm.</span>
<span class="sd">            preallocate: Initial allocation size.</span>
<span class="sd">            string_fixed_length: Character length for fixed-length strings.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">                         If group.file.swmr_mode is True and datasets don&#39;t exist.</span>
<span class="sd">            ValueError: If series validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Prevent object creation under SWMR (SWMR programming model compliance)</span>
        <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">swmr_mode</span> <span class="ow">and</span> <span class="n">dataset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot create new datasets while SWMR mode is enabled. &quot;</span>
                    <span class="s2">&quot;Create all refine before starting SWMR mode.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Encode series for schema information using fixed-length strings</span>
        <span class="n">encoded_values</span><span class="p">,</span> <span class="n">values_mask</span><span class="p">,</span> <span class="n">values_kind</span><span class="p">,</span> <span class="n">orig_values_dtype</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">_encode_values_for_hdf5</span><span class="p">(</span><span class="n">series</span><span class="p">,</span> <span class="n">string_fixed_length</span><span class="o">=</span><span class="n">string_fixed_length</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">encoded_index</span><span class="p">,</span> <span class="n">index_masks</span><span class="p">,</span> <span class="n">index_metadata</span><span class="p">,</span> <span class="n">orig_index_dtype</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">_encode_index_for_hdf5</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">string_fixed_length</span><span class="o">=</span><span class="n">string_fixed_length</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Create values dataset</span>
        <span class="k">if</span> <span class="n">values_kind</span> <span class="o">==</span> <span class="s2">&quot;numeric_float64&quot;</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">_create_resizable_dataset</span><span class="p">(</span>
                    <span class="n">group</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="n">preallocate</span><span class="p">,),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,),</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">compression</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># string_utf8_fixed or string_utf8_vlen</span>
            <span class="k">if</span> <span class="n">values_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">(</span><span class="n">string_fixed_length</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">()</span>

            <span class="n">HDF</span><span class="o">.</span><span class="n">_create_resizable_dataset</span><span class="p">(</span>
                    <span class="n">group</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">preallocate</span><span class="p">,),</span>
                    <span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                    <span class="n">chunks</span><span class="p">,</span>
                    <span class="n">compression</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># Create values mask</span>
            <span class="n">mask_dataset</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_create_resizable_dataset</span><span class="p">(</span>
                    <span class="n">group</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">preallocate</span><span class="p">,),</span>
                    <span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                    <span class="n">chunks</span><span class="p">,</span>
                    <span class="n">compression</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mask_dataset</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Initialize to all missing</span>

        <span class="c1"># Create index datasets</span>
        <span class="n">index_kind</span> <span class="o">=</span> <span class="n">index_metadata</span><span class="p">[</span><span class="s2">&quot;index_kind&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">index_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
            <span class="n">index_dtype</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">(</span><span class="n">string_fixed_length</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_dtype</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_get_string_dtype</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">index_metadata</span><span class="p">[</span><span class="s2">&quot;index_is_multiindex&quot;</span><span class="p">]:</span>
            <span class="c1"># Create index group and level datasets</span>
            <span class="n">index_group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">index_dataset</span><span class="p">)</span>
            <span class="n">levels_group</span> <span class="o">=</span> <span class="n">index_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;levels&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">index_metadata</span><span class="p">[</span><span class="s2">&quot;index_levels&quot;</span><span class="p">]):</span>
                <span class="n">HDF</span><span class="o">.</span><span class="n">_create_resizable_dataset</span><span class="p">(</span>
                        <span class="n">levels_group</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">index_dtype</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">preallocate</span><span class="p">,),</span>
                        <span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                        <span class="n">chunks</span><span class="p">,</span>
                        <span class="n">compression</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mask_dataset</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_create_resizable_dataset</span><span class="p">(</span>
                        <span class="n">levels_group</span><span class="p">,</span>
                        <span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
                        <span class="p">(</span><span class="n">preallocate</span><span class="p">,),</span>
                        <span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                        <span class="n">chunks</span><span class="p">,</span>
                        <span class="n">compression</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mask_dataset</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Initialize to all missing</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Create index group</span>
            <span class="n">index_group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="n">index_dataset</span><span class="p">)</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">_create_resizable_dataset</span><span class="p">(</span>
                    <span class="n">index_group</span><span class="p">,</span>
                    <span class="s2">&quot;values&quot;</span><span class="p">,</span>
                    <span class="n">index_dtype</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">preallocate</span><span class="p">,),</span>
                    <span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                    <span class="n">chunks</span><span class="p">,</span>
                    <span class="n">compression</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mask_dataset</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_create_resizable_dataset</span><span class="p">(</span>
                    <span class="n">index_group</span><span class="p">,</span>
                    <span class="s2">&quot;index_mask&quot;</span><span class="p">,</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">preallocate</span><span class="p">,),</span>
                    <span class="p">(</span><span class="kc">None</span><span class="p">,),</span>
                    <span class="n">chunks</span><span class="p">,</span>
                    <span class="n">compression</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mask_dataset</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Initialize to all missing</span>

        <span class="c1"># Set attributes</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;series_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">series</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> <span class="n">series</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Logical length is 0</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;values_kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_kind</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orig_values_dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_values_dtype</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;orig_index_dtype&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_index_dtype</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;created_at_iso&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;1.0&quot;</span>

        <span class="c1"># Set string fixed length attributes when applicable</span>
        <span class="k">if</span> <span class="n">values_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;string_fixed_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_fixed_length</span>
        <span class="k">if</span> <span class="n">index_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;index_string_fixed_length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_fixed_length</span>

        <span class="c1"># Add index metadata</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">index_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div>


<div class="viewcode-block" id="HDF.save_series_new">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.save_series_new">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_series_new</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span>
            <span class="n">index_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="n">chunks</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,),</span>
            <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="n">preallocate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">string_fixed_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create datasets and write a pandas Series to HDF5.</span>

<span class="sd">        Creates new datasets or reuses existing preallocated layout.</span>
<span class="sd">        Writes the first len(series) elements and sets logical length.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group to write to.</span>
<span class="sd">            series: pandas Series to persist.</span>
<span class="sd">            dataset: Name for the values dataset.</span>
<span class="sd">            index_dataset: Name for the index dataset.</span>
<span class="sd">            chunks: Chunk shape for new datasets.</span>
<span class="sd">            compression: Compression algorithm for new datasets.</span>
<span class="sd">            preallocate: Initial allocation size for new datasets.</span>
<span class="sd">            string_fixed_length: Character length for fixed-length strings.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">            ValueError: If series validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot save empty series&quot;</span><span class="p">)</span>

        <span class="c1"># Check if layout already exists (preallocated)</span>
        <span class="k">if</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">group</span> <span class="ow">and</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;len&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Use existing preallocated layout</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">save_series_update</span><span class="p">(</span>
                    <span class="n">group</span><span class="p">,</span>
                    <span class="n">series</span><span class="p">,</span>
                    <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                    <span class="n">index_dataset</span><span class="o">=</span><span class="n">index_dataset</span><span class="p">,</span>
                    <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Creation path: if require_swmr=True, only permit write (no object creation)</span>
        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="c1"># For SWMR writes, datasets must already exist</span>
            <span class="k">if</span> <span class="n">dataset</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Datasets must be created before starting SWMR mode. &quot;</span>
                        <span class="s2">&quot;Use preallocate_series_layout() first, then start SWMR.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Use update path</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">save_series_update</span><span class="p">(</span>
                    <span class="n">group</span><span class="p">,</span>
                    <span class="n">series</span><span class="p">,</span>
                    <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                    <span class="n">index_dataset</span><span class="o">=</span><span class="n">index_dataset</span><span class="p">,</span>
                    <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Create new layout (require_swmr=False for creation phase)</span>
        <span class="n">HDF</span><span class="o">.</span><span class="n">preallocate_series_layout</span><span class="p">(</span>
                <span class="n">group</span><span class="p">,</span>
                <span class="n">series</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">index_dataset</span><span class="o">=</span><span class="n">index_dataset</span><span class="p">,</span>
                <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                <span class="n">preallocate</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">preallocate</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)),</span>
                <span class="n">string_fixed_length</span><span class="o">=</span><span class="n">string_fixed_length</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Write the data</span>
        <span class="n">HDF</span><span class="o">.</span><span class="n">save_series_update</span><span class="p">(</span>
                <span class="n">group</span><span class="p">,</span>
                <span class="n">series</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">index_dataset</span><span class="o">=</span><span class="n">index_dataset</span><span class="p">,</span>
                <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HDF.save_series_update">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.save_series_update">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_series_update</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span>
            <span class="n">index_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update a pandas Series in HDF5 at specified position.</span>

<span class="sd">        Overwrites [start:start+len(series)] and updates logical length</span>
<span class="sd">        to the largest contiguous written extent.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group containing existing datasets.</span>
<span class="sd">            series: pandas Series to write.</span>
<span class="sd">            start: Starting position for the update.</span>
<span class="sd">            dataset: Name of the values dataset.</span>
<span class="sd">            index_dataset: Name of the index dataset.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">            ValueError: If validation fails or schema mismatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot update with empty series&quot;</span><span class="p">)</span>

        <span class="n">current_len</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">series</span><span class="p">)</span>

        <span class="c1"># Validate that this is a contiguous update</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">current_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Non-contiguous update: start=</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, current_len=</span><span class="si">{</span><span class="n">current_len</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Get stored schema to determine if fixed-length strings are used</span>
        <span class="n">stored_values_kind</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;values_kind&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stored_values_kind</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">stored_values_kind</span> <span class="o">=</span> <span class="n">stored_values_kind</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="n">stored_index_kind</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;index_kind&quot;</span><span class="p">,</span> <span class="s2">&quot;string_utf8_vlen&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stored_index_kind</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">stored_index_kind</span> <span class="o">=</span> <span class="n">stored_index_kind</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

        <span class="c1"># Check for SWMR restrictions on variable-length strings</span>
        <span class="k">if</span> <span class="n">require_swmr</span> <span class="ow">and</span> <span class="n">group</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">swmr_mode</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">stored_values_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_vlen&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot write to variable-length string datasets under SWMR mode. &quot;</span>
                        <span class="s2">&quot;Variable-length string writes are not allowed in SWMR mode.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">stored_index_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_vlen&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Cannot write to variable-length string index datasets under SWMR mode. &quot;</span>
                        <span class="s2">&quot;Variable-length string writes are not allowed in SWMR mode.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Get fixed-length parameters from stored attributes</span>
        <span class="n">string_fixed_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">stored_values_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
            <span class="n">string_fixed_length</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;string_fixed_length&quot;</span><span class="p">]</span>

        <span class="n">index_string_fixed_length</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">stored_index_kind</span> <span class="o">==</span> <span class="s2">&quot;string_utf8_fixed&quot;</span><span class="p">:</span>
            <span class="n">index_string_fixed_length</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;index_string_fixed_length&quot;</span><span class="p">]</span>

        <span class="c1"># Encode data using stored schema</span>
        <span class="n">encoded_values</span><span class="p">,</span> <span class="n">values_mask</span><span class="p">,</span> <span class="n">values_kind</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_encode_values_for_hdf5</span><span class="p">(</span>
                <span class="n">series</span><span class="p">,</span> <span class="n">string_fixed_length</span><span class="o">=</span><span class="n">string_fixed_length</span>
        <span class="p">)</span>
        <span class="n">encoded_index</span><span class="p">,</span> <span class="n">index_masks</span><span class="p">,</span> <span class="n">index_metadata</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_encode_index_for_hdf5</span><span class="p">(</span>
                <span class="n">series</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">string_fixed_length</span><span class="o">=</span><span class="n">index_string_fixed_length</span>
        <span class="p">)</span>

        <span class="c1"># Validate schema compatibility</span>
        <span class="k">if</span> <span class="n">stored_values_kind</span> <span class="o">!=</span> <span class="n">values_kind</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Values kind mismatch: expected </span><span class="si">{</span><span class="n">stored_values_kind</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">values_kind</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">expected_multiindex</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;index_is_multiindex&quot;</span><span class="p">])</span>
        <span class="n">actual_multiindex</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">index_metadata</span><span class="p">[</span><span class="s2">&quot;index_is_multiindex&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">expected_multiindex</span> <span class="o">!=</span> <span class="n">actual_multiindex</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Index type mismatch: expected multiindex=</span><span class="si">{</span><span class="n">expected_multiindex</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="n">actual_multiindex</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Resize datasets if needed</span>
        <span class="n">values_dataset</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">dataset</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">end_pos</span> <span class="o">&gt;</span> <span class="n">values_dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">values_dataset</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">end_pos</span><span class="p">,))</span>
            <span class="k">if</span> <span class="n">values_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">end_pos</span><span class="p">,))</span>

        <span class="c1"># Write values</span>
        <span class="n">values_dataset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoded_values</span>
        <span class="k">if</span> <span class="n">values_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">values_mask</span>

        <span class="c1"># Write index</span>
        <span class="k">if</span> <span class="n">expected_multiindex</span><span class="p">:</span>
            <span class="n">levels_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">index_dataset</span><span class="si">}</span><span class="s2">/levels&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">level_data</span><span class="p">,</span> <span class="n">level_mask</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">encoded_index</span><span class="p">,</span> <span class="n">index_masks</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">level_dataset</span> <span class="o">=</span> <span class="n">levels_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">end_pos</span> <span class="o">&gt;</span> <span class="n">level_dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">level_dataset</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">end_pos</span><span class="p">,))</span>
                    <span class="n">levels_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">end_pos</span><span class="p">,))</span>
                <span class="n">level_dataset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_data</span>
                <span class="n">levels_group</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;L</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_mask&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">level_mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">index_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">index_dataset</span><span class="p">]</span>
            <span class="n">index_values_dataset</span> <span class="o">=</span> <span class="n">index_group</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">end_pos</span> <span class="o">&gt;</span> <span class="n">index_values_dataset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">index_values_dataset</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">end_pos</span><span class="p">,))</span>
                <span class="n">index_group</span><span class="p">[</span><span class="s2">&quot;index_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">resize</span><span class="p">((</span><span class="n">end_pos</span><span class="p">,))</span>
            <span class="n">index_values_dataset</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoded_index</span>
            <span class="n">index_group</span><span class="p">[</span><span class="s2">&quot;index_mask&quot;</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end_pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">index_masks</span>

        <span class="c1"># Update logical length</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_len</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="HDF.save_series_append">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.save_series_append">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_series_append</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">series</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span>
            <span class="n">index_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append a pandas Series to existing HDF5 datasets.</span>

<span class="sd">        Appends at the end using current logical length.</span>
<span class="sd">        Resizes datasets if needed and updates logical length.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group containing existing datasets.</span>
<span class="sd">            series: pandas Series to append.</span>
<span class="sd">            dataset: Name of the values dataset.</span>
<span class="sd">            index_dataset: Name of the index dataset.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">            ValueError: If validation fails or schema mismatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="n">current_len</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
        <span class="n">HDF</span><span class="o">.</span><span class="n">save_series_update</span><span class="p">(</span>
                <span class="n">group</span><span class="p">,</span>
                <span class="n">series</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">current_len</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span>
                <span class="n">index_dataset</span><span class="o">=</span><span class="n">index_dataset</span><span class="p">,</span>
                <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="HDF.load_series">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.load_series">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_series</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;values&quot;</span><span class="p">,</span>
            <span class="n">index_dataset</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a pandas Series from HDF5 storage.</span>

<span class="sd">        Reconstructs the Series with original name, index names, order,</span>
<span class="sd">        and missingness. Respects logical length from attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group containing the Series data.</span>
<span class="sd">            dataset: Name of the values dataset.</span>
<span class="sd">            index_dataset: Name of the index dataset.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Reconstructed pandas Series.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">            ValueError: If data validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="n">logical_length</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">logical_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Return empty series with proper schema</span>
            <span class="n">series_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;series_name&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series_name</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">series_name</span> <span class="o">=</span> <span class="n">series_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">series_name</span> <span class="o">=</span> <span class="n">series_name</span> <span class="k">if</span> <span class="n">series_name</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([],</span> <span class="n">name</span><span class="o">=</span><span class="n">series_name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>

        <span class="c1"># Decode values and index</span>
        <span class="n">values</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_decode_values_from_hdf5</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">logical_length</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_decode_index_from_hdf5</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">index_dataset</span><span class="p">,</span> <span class="n">logical_length</span><span class="p">)</span>

        <span class="c1"># Get series name</span>
        <span class="n">series_name</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;series_name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">series_name</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">series_name</span> <span class="o">=</span> <span class="n">series_name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">series_name</span> <span class="o">=</span> <span class="n">series_name</span> <span class="k">if</span> <span class="n">series_name</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">series_name</span><span class="p">)</span></div>


    <span class="c1"># =================== DATAFRAME FUNCTIONS ===================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_categorical_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert categorical columns to their non-categorical representation.</span>
<span class="sd">        </span>
<span class="sd">        This method converts any categorical dtype columns to their underlying</span>
<span class="sd">        data type representation, preserving the actual values but removing the</span>
<span class="sd">        categorical encoding.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            dataframe: pandas DataFrame that may contain categorical columns.</span>
<span class="sd">            </span>
<span class="sd">        Returns:</span>
<span class="sd">            DataFrame with categorical columns converted to their base dtypes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_categorical_dtype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]):</span>
                <span class="c1"># Convert categorical to its underlying dtype</span>
                <span class="c1"># This preserves the actual values but removes categorical encoding</span>
                <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>

<div class="viewcode-block" id="HDF.preallocate_frame_layout">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.preallocate_frame_layout">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">preallocate_frame_layout</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">chunks</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,),</span>
            <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="n">preallocate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">string_fixed_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Preallocate HDF5 layout for a pandas DataFrame without writing data.</span>

<span class="sd">        Creates layout for shared index and column series using Series preallocation.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group to write to.</span>
<span class="sd">            dataframe: pandas DataFrame to create layout for.</span>
<span class="sd">            chunks: Chunk shape for datasets.</span>
<span class="sd">            compression: Compression algorithm.</span>
<span class="sd">            preallocate: Initial allocation size.</span>
<span class="sd">            string_fixed_length: Character length for fixed-length strings.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">                         If group.file.swmr_mode is True and datasets don&#39;t exist.</span>
<span class="sd">            ValueError: If DataFrame validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert categorical columns to their base dtypes</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_convert_categorical_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="c1"># Prevent object creation under SWMR (SWMR programming model compliance)</span>
        <span class="k">if</span> <span class="n">group</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">swmr_mode</span> <span class="ow">and</span> <span class="s2">&quot;index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                    <span class="s2">&quot;Cannot create new groups/datasets while SWMR mode is enabled. &quot;</span>
                    <span class="s2">&quot;Create all refine before starting SWMR mode.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot preallocate layout for DataFrame with no columns&quot;</span><span class="p">)</span>

        <span class="c1"># Set frame attributes</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;column_order&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Preallocate index layout</span>
        <span class="n">index_group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="c1"># Create a dummy series with string values to match the schema</span>
        <span class="n">dummy_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;__index__&quot;</span><span class="p">)</span>
        <span class="n">HDF</span><span class="o">.</span><span class="n">preallocate_series_layout</span><span class="p">(</span>
                <span class="n">index_group</span><span class="p">,</span>
                <span class="n">dummy_series</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">,</span>
                <span class="n">index_dataset</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                <span class="n">preallocate</span><span class="o">=</span><span class="n">preallocate</span><span class="p">,</span>
                <span class="n">string_fixed_length</span><span class="o">=</span><span class="n">string_fixed_length</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Preallocate column layouts</span>
        <span class="n">columns_group</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">col_group</span> <span class="o">=</span> <span class="n">columns_group</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">col_name</span><span class="p">))</span>
            <span class="c1"># Create dummy series - use actual data to determine schema if available</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Use first few values to determine the proper schema</span>
                <span class="n">col_data</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
                <span class="n">dummy_col_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">col_data</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">col_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">],</span>
                        <span class="n">dtype</span><span class="o">=</span><span class="n">col_data</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
                        <span class="n">index</span><span class="o">=</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">col_name</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Fallback to dtype for empty dataframe</span>
                <span class="n">col_dtype</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
                <span class="n">dummy_col_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                        <span class="p">[],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">col_dtype</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="n">col_name</span>
                <span class="p">)</span>

            <span class="n">HDF</span><span class="o">.</span><span class="n">preallocate_series_layout</span><span class="p">(</span>
                    <span class="n">col_group</span><span class="p">,</span>
                    <span class="n">dummy_col_series</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">,</span>
                    <span class="n">index_dataset</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                    <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
                    <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                    <span class="n">preallocate</span><span class="o">=</span><span class="n">preallocate</span><span class="p">,</span>
                    <span class="n">string_fixed_length</span><span class="o">=</span><span class="n">string_fixed_length</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="HDF.save_frame_new">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.save_frame_new">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_frame_new</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">chunks</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25</span><span class="p">,),</span>
            <span class="n">compression</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;gzip&quot;</span><span class="p">,</span>
            <span class="n">preallocate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">string_fixed_length</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create datasets and write a pandas DataFrame to HDF5.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group to write to.</span>
<span class="sd">            dataframe: pandas DataFrame to persist.</span>
<span class="sd">            chunks: Chunk shape for new datasets.</span>
<span class="sd">            compression: Compression algorithm for new datasets.</span>
<span class="sd">            preallocate: Initial allocation size for new datasets.</span>
<span class="sd">            string_fixed_length: Character length for fixed-length strings.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">            ValueError: If DataFrame validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert categorical columns to their base dtypes</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_convert_categorical_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot save empty DataFrame&quot;</span><span class="p">)</span>

        <span class="c1"># Check if layout already exists (preallocated)</span>
        <span class="k">if</span> <span class="s2">&quot;columns&quot;</span> <span class="ow">in</span> <span class="n">group</span> <span class="ow">and</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;len&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">save_frame_update</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Creation path: if require_swmr=True, only permit write (no object creation)</span>
        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="c1"># For SWMR writes, groups/datasets must already exist</span>
            <span class="k">if</span> <span class="s2">&quot;columns&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                        <span class="s2">&quot;Groups/datasets must be created before starting SWMR mode. &quot;</span>
                        <span class="s2">&quot;Use preallocate_frame_layout() first, then start SWMR.&quot;</span>
                <span class="p">)</span>
            <span class="c1"># Use update path</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">save_frame_update</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Create new layout (require_swmr=False for creation phase)</span>
        <span class="n">HDF</span><span class="o">.</span><span class="n">preallocate_frame_layout</span><span class="p">(</span>
                <span class="n">group</span><span class="p">,</span>
                <span class="n">dataframe</span><span class="p">,</span>
                <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
                <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                <span class="n">preallocate</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">preallocate</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)),</span>
                <span class="n">string_fixed_length</span><span class="o">=</span><span class="n">string_fixed_length</span><span class="p">,</span>
                <span class="n">require_swmr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Write the data</span>
        <span class="n">HDF</span><span class="o">.</span><span class="n">save_frame_update</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.save_frame_update">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.save_frame_update">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_frame_update</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update a pandas DataFrame in HDF5 at specified position.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group containing existing datasets.</span>
<span class="sd">            dataframe: pandas DataFrame to write.</span>
<span class="sd">            start: Starting position for the update.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">            ValueError: If validation fails or schema mismatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert categorical columns to their base dtypes</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_convert_categorical_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot update with empty DataFrame&quot;</span><span class="p">)</span>

        <span class="n">current_len</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
        <span class="n">end_pos</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>

        <span class="c1"># Validate contiguous update</span>
        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">current_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Non-contiguous update: start=</span><span class="si">{</span><span class="n">start</span><span class="si">}</span><span class="s2">, current_len=</span><span class="si">{</span><span class="n">current_len</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Validate column order matches</span>
        <span class="n">column_order_attr</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;column_order&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_order_attr</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">column_order_attr</span> <span class="o">=</span> <span class="n">column_order_attr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">stored_columns</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">column_order_attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">!=</span> <span class="n">stored_columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Column order mismatch: expected </span><span class="si">{</span><span class="n">stored_columns</span><span class="si">}</span><span class="s2">, got </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Update index - create a dummy series to represent the actual index</span>
        <span class="c1"># We need to store the index structure, so we create a dummy series where the</span>
        <span class="c1"># index is the actual DataFrame index and values are just placeholders</span>
        <span class="n">index_series</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;dummy&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">dataframe</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">dataframe</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;__index__&quot;</span>
        <span class="p">)</span>
        <span class="n">HDF</span><span class="o">.</span><span class="n">save_series_update</span><span class="p">(</span>
                <span class="n">group</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span>
                <span class="n">index_series</span><span class="p">,</span>
                <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">,</span>
                <span class="n">index_dataset</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Update each column</span>
        <span class="n">columns_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">col_series</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span>
            <span class="n">col_series</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">col_name</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">save_series_update</span><span class="p">(</span>
                    <span class="n">columns_group</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col_name</span><span class="p">)],</span>
                    <span class="n">col_series</span><span class="p">,</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">,</span>
                    <span class="n">index_dataset</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                    <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Update frame length</span>
        <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">current_len</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="HDF.save_frame_append">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.save_frame_append">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_frame_append</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Append a pandas DataFrame to existing HDF5 datasets.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group containing existing datasets.</span>
<span class="sd">            dataframe: pandas DataFrame to append.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">            ValueError: If validation fails or schema mismatch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Convert categorical columns to their base dtypes</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_convert_categorical_columns</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="n">current_len</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
        <span class="n">HDF</span><span class="o">.</span><span class="n">save_frame_update</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">current_len</span><span class="p">,</span> <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">)</span></div>


<div class="viewcode-block" id="HDF.load_frame">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.load_frame">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_frame</span><span class="p">(</span>
            <span class="n">group</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">,</span>
            <span class="o">*</span><span class="p">,</span>
            <span class="n">require_swmr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Load a pandas DataFrame from HDF5 storage.</span>

<span class="sd">        Args:</span>
<span class="sd">            group: HDF5 group containing the DataFrame data.</span>
<span class="sd">            require_swmr: If True, assert SWMR mode is enabled.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Reconstructed pandas DataFrame.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If require_swmr=True and SWMR mode not enabled.</span>
<span class="sd">            ValueError: If data validation fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">require_swmr</span><span class="p">:</span>
            <span class="n">HDF</span><span class="o">.</span><span class="n">assert_swmr_on</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>

        <span class="n">logical_length</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;len&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">logical_length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Return empty DataFrame with proper schema</span>
            <span class="n">column_order_attr</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;column_order&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_order_attr</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">column_order_attr</span> <span class="o">=</span> <span class="n">column_order_attr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">column_order</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">column_order_attr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">column_order</span><span class="p">)</span>

        <span class="c1"># Load index</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">_decode_index_from_hdf5</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">],</span> <span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="n">logical_length</span><span class="p">)</span>

        <span class="c1"># Load columns in order</span>
        <span class="n">column_order_attr</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;column_order&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_order_attr</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">column_order_attr</span> <span class="o">=</span> <span class="n">column_order_attr</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">column_order</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">column_order_attr</span><span class="p">)</span>
        <span class="n">columns_group</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span>

        <span class="n">columns_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">column_order</span><span class="p">:</span>
            <span class="n">col_series</span> <span class="o">=</span> <span class="n">HDF</span><span class="o">.</span><span class="n">load_series</span><span class="p">(</span>
                    <span class="n">columns_group</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">col_name</span><span class="p">)],</span>
                    <span class="n">dataset</span><span class="o">=</span><span class="s2">&quot;values&quot;</span><span class="p">,</span>
                    <span class="n">index_dataset</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span>
                    <span class="n">require_swmr</span><span class="o">=</span><span class="n">require_swmr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">columns_data</span><span class="p">[</span><span class="n">col_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">col_series</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># Reconstruct DataFrame</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns_data</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">)</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">column_order</span><span class="p">]</span>  <span class="c1"># Ensure column order</span>
        <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="HDF.close_handle">
<a class="viewcode-back" href="../../../api_reference/phenotypic.tools.hdf_.html#phenotypic.tools.HDF.close_handle">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">close_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span> <span class="o">|</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handle</span> <span class="o">=</span> <span class="n">handle</span><span class="o">.</span><span class="n">file</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">Group</span><span class="p">)</span> <span class="k">else</span> <span class="n">handle</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">handle</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;HDF5 file handle may not have been properly closed&#39;</span><span class="p">)</span>

                    <span class="c1"># Force close</span>
                    <span class="n">handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;HDF5 file handle properly closed&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="c1"># Handle is closed/invalid - this is expected</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;hdf5 file handle </span><span class="si">{</span><span class="n">handle</span><span class="si">}</span><span class="s1"> was properly closed or invalid&#39;</span><span class="p">)</span></div>
</div>

</pre></div>

                </article>
              
              
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2025, ExFAB BioFoundry.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>